.table-responsive.card
  %table.table.table-bordered.table-striped
    %thead
      %tr
        %th{colspan: 11} All enrolled patients
        %th.agency-performance__date-effected{colspan: 2} Activity occurred between #{report.range.first} and #{report.range.last}
      %tr.agency-performance__labels
        %th= entity_label
        %th Patients Assigned
        %th Consented
        -# %th With CHA
        -# %th.agency-performance__without Without CHA
        -# %th With SSM
        -# %th.agency-performance__without Without SSM
        %th
          .agency-performance__category.mb-1 Payment
          With Signed Care Plan
        %th
          .agency-performance__category.mb-1 Quality
          Initial care plan due within 31 days
        %th
          .agency-performance__category.mb-1 Payment
          Initial care plan due within 28 days
        %th
          .agency-performance__category.mb-1 Payment
          Initial care plan overdue
        %th
          .agency-performance__category.mb-1 Quality
          Annual care plan due within 30 days
        %th
          .agency-performance__category.mb-1 Quality
          Care plan renewal overdue
        %th
          .agency-performance__category.mb-1 Quality
          No annual well care visits in 12-month range
        %th
          .agency-performance__category.mb-1 Quality
          No F2F visit in past 6 months
        -# %th.agency-performance__without Without Signed Care Plan
        -# %th.agency-performance__date-effected Care Plans Signed
        -# %th Care Plan Signed Within 122 Days of Enrollment
        -#%th.agency-performance__without No QAa
        %th.agency-performance__date-effected
          .agency-performance__category.mb-1 Quality
          3 day post-discharge follow ups completed
        %th
          .agency-performance__category.mb-1 Payment
          No Payable QAs
    %tbody
      - entities.each do |entity|
        - entity_slug = entity.id || entity.name
        %tr
          %th= entity.name
          %td.text-right
            - scope = entity.patient_referrals
            - title = "#{pluralize(scope.size, 'Patient')} Assigned"
            =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path
          %td.text-right
            - scope = entity.consented_patients
            - title = "#{pluralize(scope.size, 'Patient')} Consented"
            =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path
          -# %td.text-right
          -#   - scope = entity.with_chas
          -#   - title = "#{pluralize(scope.size, 'Patient')} with CHAs"
          -#   =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path
          -# %td.agency-performance__without.text-right
          -#   - scope = entity.without_chas
          -#   - title = "#{pluralize(scope.size, 'Patient')} without CHAs"
          -#   =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path
          -# %td.text-right
          -#   - scope = entity.with_ssms
          -#   - title = "#{pluralize(scope.size, 'Patient')} with SSMs"
          -#   =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path
          -# %td.agency-performance__without.text-right
          -#   - scope = entity.without_ssms
          -#   - title = "#{pluralize(scope.size, 'Patient')} without SSMs"
          -#   =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path

          %td.text-right
            - scope = entity.with_signed_careplans
            - title = "#{pluralize(scope.size, 'Patient')} with Signed Care Plans"
            =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path

          %td.text-right
            - scope = entity.without_initial_careplan_90_122_days
            - title = "#{pluralize(scope.size, 'Patient')} with Initial Care Plan due within 31 days (90-121 days since enrollment)"
            =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path
          %td.text-right
            - scope = entity.without_initial_careplan_122_150_days
            - title = "#{pluralize(scope.size, 'Patient')} with Initial Care Plan due within 28 days (122-149 days since enrollment)"
            =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path
          %td.text-right
            - scope = entity.initial_careplan_overdue
            - title = "#{pluralize(scope.size, 'Patient')} with Initial Care Plan Overdue"
            =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path
          %td.text-right
            - scope = entity.annual_careplan_due_within_30_days
            - title = "#{pluralize(scope.size, 'Patient')} with Annual Care Plan due within 30 days"
            =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path
          %td.text-right
            - scope = entity.annual_careplan_overdue
            - title = "#{pluralize(scope.size, 'Patient')} with Care Plan Renewal Overdue"
            =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path
          %td.text-right
            - scope = entity.without_annual_well_care_visit_in_12_months
            - start_date = (Date.today - 15.months).strftime "%m/%d/%Y"
            - end_date = (Date.today - 3.months).strftime "%m/%d/%Y"
            - title = "#{pluralize(scope.size, 'Patient')} with no Annual Well Care visit in 12 month range (#{start_date}-#{end_date})"
            =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path
          %td.text-right
            - scope = entity.without_f2f_in_past_6_months
            - title = "#{pluralize(scope.size, 'Patient')} with no Face to Face visit in past 6 months"
            =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path

          %td.agency-performance__date-effected.text-right
            - scope = entity.with_discharge_followup_completed_within_range
            - title = "#{pluralize(scope.size, 'Patient')} with 3 day post-discharge follow ups completed in Chosen Date Range"
            =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path

          -# %td.agency-performance__without.text-right
          -#   - scope = entity.without_signed_careplans
          -#   - title = "#{pluralize(scope.size, 'Patient')} without Signed Care Plans"
          -#   =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path
          -# %td.agency-performance__date-effected.text-right
          -#   - scope = entity.with_careplans_signed_within_range
          -#   - title = "#{pluralize(scope.size, 'Patient')} with Care Plans Signed Within Period"
          -#   =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path
          -# %td.text-right
          -#   - scope = entity.with_careplans_in_122_days
          -#   - title = "#{pluralize(scope.size, 'Patient')} with Care Plans Signed During Period"
          -#   - numerator = scope.size
          -#   - denominator = entity.with_careplans_signed_within_range.size
          -#   - percentage = 0
          -#   - percentage = ((numerator/denominator.to_f) * 100).round if denominator.positive? && numerator.positive?
          -#   - link_text = "#{numerator}  (#{percentage}%)"
          -#   =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path, link_text: link_text

          %td.text-right
            - scope = entity.without_payable_qualifying_activities_within_range
            - title = "#{pluralize(scope.size, 'Patient')} without Payable QAs in Chosen Date Range"
            =render 'warehouse_reports/health/agency_performance/table_cell', permission: permission, entity_slug: entity_slug, scope: scope, title: title, detail_path: detail_path
    - if entities.size > 1
      %tfoot
        %tr
          %td= totals.name
          %td.text-right= totals.patient_referrals.size
          %td.text-right= totals.consented_patients.size
          %td.text-right= totals.with_signed_careplans.size
          %td.text-right= totals.without_initial_careplan_90_122_days.size
          %td.text-right= totals.without_initial_careplan_122_150_days.size
          %td.text-right= totals.initial_careplan_overdue.size
          %td.text-right= totals.annual_careplan_due_within_30_days.size
          %td.text-right= totals.annual_careplan_overdue.size
          %td.text-right= totals.without_annual_well_care_visit_in_12_months.size
          %td.text-right= totals.without_f2f_in_past_6_months.size
          %td.agency-performance__date-effected.text-right= totals.with_discharge_followup_completed_within_range.size
          -# %td.agency-performance__without.text-right= totals.without_chas.size
          -# %td.text-right= totals.with_ssms.size
          -# %td.agency-performance__without.text-right= totals.without_ssms.size
          -# %td.agency-performance__without.text-right= totals.without_signed_careplans.size
          -# %td.agency-performance__date-effected.text-right= totals.with_careplans_signed_within_range.size
          -# %td.text-right
          -#   - numerator = totals.with_careplans_in_122_days.size
          -#   - denominator = totals.with_careplans_signed_within_range.size
          -#   - percentage = 0
          -#   - percentage = ((numerator/denominator.to_f) * 100).round if denominator.positive? && numerator.positive?
          -#   = totals.with_careplans_in_122_days.size
          -#   (#{percentage}%)
          -#%td.agency-performance__without.text-right= totals.without_qualifying_activities_within_range.size
          %td.text-right= totals.without_payable_qualifying_activities_within_range.size
  = content_for :page_js do
    :javascript
      $(document).ready(function() {
        $('.btn').each(function(i){
          $(this).removeAttr('data-disable-with');
        });
      });
