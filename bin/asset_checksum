# Theme files to reset -- see .gitignore
# Remove anything on these paths to ensure lingering theme files do not interfere.
find app/assets -type f -name '.DS_Store' -delete
rm -rf app/assets/stylesheets/theme/styles
rm -rf app/assets/images/theme/logo
rm -rf app/assets/images/theme/icons

if [ "$ASSETS_PREFIX" = "" ]; then
  export ASSETS_PREFIX=qa-warehouse-staging-ecs
fi

if [ "$SECRET_ARN" != "" ]; then
  bin/download_secrets.rb > .env.secret
else
  echo 'No $SECRET_ARN!'
  exit 1
fi

ASSETS_BUCKET_NAME=openpath-ecs-assets UPDATE_ONLY=false ./bin/sync_app_assets.rb > /dev/null 2>&1

tar -cf - --sort=name \
  --mtime='UTC 2019-01-01' \
  --group=0 \
  --owner=0 \
  --numeric-owner \
  --absolute-names \
  --no-acls \
  --mode="go-rwx,u-rw" \
  --exclude=.keep,*.rbc,**.orig,*.swp \
  app/assets .env.secret | md5sum | cut -d ' ' -f 1
