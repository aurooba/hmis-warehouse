= render 'breadcrumbs'
= render 'beta_warning'

- title = "Homeless Summary Report"
- content_for :title, title
%h1= content_for :title
%p= "Created by #{@report.user.name_with_email} on #{@report.completed_at.to_date}"
.well.report-listing.warehouse-reports__completed
  = @report.filter.describe_filter_as_html

- @report.measures.each do |measure, data|
  - measure_slug = measure.underscore.tr(' ', '_')
  .d-flex
    %h2= measure
    .ml-auto
      %a{href: '#', data: {toggle: :collapse, target: "\##{measure_slug}"}, aria: {expanded: 'false', controls: measure_slug}}
        View details
        %i.icon-arrow-circled-down
  - @report.variants.each do |base_variant_slug, details|
    - detail_variant_name = "spm_#{base_variant_slug}__all"
    .collapse{id: measure_slug}
      - base_variant = details[:base_variant]
      = render 'counts_table', data: data, detail_variant_name: detail_variant_name, title: base_variant[:name], measure: measure
      - details[:variants].each do |sub_variant_slug, variant|
        = render 'counts_table', data: data, detail_variant_name: "spm_#{base_variant_slug}__#{sub_variant_slug.presence}", title: variant[:name], measure: measure
    - data[:fields].each do |row|
      = render 'chart', data: row, detail_variant_name: detail_variant_name, title: base_variant[:name], measure: measure, headers: data[:headers]
    .mb-2
      - sub_variant_slug = "#{measure.underscore.tr(' ', '_')}_#{detail_variant_name}_sub_variants"
      %a{href: '#', data: {toggle: :collapse, target: "\##{sub_variant_slug}"}, aria: {expanded: 'false', controls: sub_variant_slug}}
        Demographic breakdowns
        %i.icon-arrow-circled-down
    .well.mb-4.collapse{id: sub_variant_slug}
      - details[:variants].each do |sub_variant_slug, variant|
        - next if @report.exclude_variants(measure, sub_variant_slug)

        - detail_variant_name = "spm_#{base_variant_slug}__#{sub_variant_slug.presence || 'all'}"
        -# = render 'chart', data: data, detail_variant_name: detail_variant_name, title: variant[:name], measure: measure
