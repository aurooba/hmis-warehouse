:javascript
  (function(){
    var controller;
    var dates = #{data.to_json.to_s.html_safe};
    var active_date = $(".#{chart_class}").data('activeDate');
    var categories = #{data[active_date]['categories'].to_json.to_s.html_safe};
    var options = {
      data: {
        columns: [],
        type: 'bar',
        groups: [#{groups.to_json.html_safe}],
        labels: {
          centered: true,
          colors: 'white',
        },
        stack: {
          normalize: true
        },
        order: null,
      },
      bar: {
        label: {
          threshold: 0.001,
        }
      },
      bindto: {
        element: ".#{chart_class}"
      },
      color: {
        pattern: #{@report.chart_color_pattern(category)}
      },
      axis: {
        rotated: true,
        x: {
          show: false,
        },
        y: {
          show: false,
        }
      },
      size: {
        height: 120,
      },
      tooltip: {
        format: {
          title: function(x) {
            return categories[x];
          },
          value: d3.format(".0%"),
        },
        order: '',
      },
      legend: false,
    };

    var chart = bb.generate(options);
    // Make the page aware of the new chart
    var charts = $('body').data('publicCharts');
    if(charts == undefined) {
      charts = []
    }
    charts.push({ chart: chart, dates: dates })
    $('body').data('publicCharts', charts);
    $('.jQuarters').trigger('change');
  })();
